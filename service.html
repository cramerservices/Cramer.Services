<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Service | Cramer Services</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f8f9fb;--card:#fff;--accent:#0d6efd;--text:#1b1f24;--muted:#6c757d;--ring:0 0 0 3px rgba(13,110,253,.25)}
  *{box-sizing:border-box} html,body{margin:0}
  body{font-family:Poppins,Arial,sans-serif;background:var(--bg);color:var(--text)}
  a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
  .container{max-width:1100px;margin:auto;padding:0 1rem}
  header{background:var(--card);border-bottom:1px solid #dee2e6}
  .nav{display:flex;align-items:center;justify-content:space-between;padding:.8rem 0}
  .brand{display:flex;gap:.6rem;align-items:center;font-weight:800}
  .brand-logo{width:36px;height:36px;background:var(--accent);color:#fff;display:grid;place-items:center;border-radius:8px}
  .cta{background:var(--accent);color:#fff;font-weight:600;padding:.7rem 1rem;border:0;border-radius:8px;cursor:pointer;display:inline-block}
  .cta:hover{background:#0b5ed7}
  .cta-secondary{background:#eef3ff;color:#0d6efd;font-weight:600;padding:.7rem 1rem;border:0;border-radius:8px;display:inline-block}
  .cta-secondary:hover{background:#e1e9ff;text-decoration:none}
  main{padding:2rem 0}
  .crumbs{font-size:.9rem;color:var(--muted);margin-bottom:.5rem}
  .product{display:grid;grid-template-columns:1.05fr .95fr;gap:2rem}
  @media (max-width: 900px){.product{grid-template-columns:1fr}}
  .media-box img,.media-box video{width:100%;height:auto;border-radius:12px;object-fit:cover;aspect-ratio:4/3;display:block}
  .media-box iframe{width:100%;aspect-ratio:16/9;border:0;border-radius:12px;display:block}
  h1{margin:.25rem 0 .25rem;font-size:1.8rem}
  .price{font-weight:800;font-size:1.25rem;margin:.35rem 0}
  .price s{font-weight:500;color:var(--muted);margin-left:.5rem}
  .desc{color:var(--muted);line-height:1.6;margin:.75rem 0 1rem}
  .bullets{margin:.5rem 0 1rem;padding-left:1rem}
  .row{display:flex;gap:.75rem;align-items:center;margin:1.25rem 0;flex-wrap:wrap}
  .row.center{justify-content:center}
  .hidden{display:none}
</style>
</head>
<body>
<header>
  <div class="container nav">
    <a class="brand" href="index.html"><span class="brand-logo">CS</span><b>Cramer Services</b></a>
    <a class="cta" href="services.html">All Services</a>
  </div>
</header>

<main class="container">
  <nav class="crumbs"><a href="index.html">Home</a> / <a href="services.html">Services</a> / <span id="crumbName">Service</span></nav>

  <div class="product">
    <div class="media-box" id="mediaBox"></div>

    <div>
      <h1 id="svcName">Service</h1>
      <div class="price" id="price"></div>
      <p class="desc" id="desc"></p>
      <ul class="bullets" id="bullets"></ul>

      <div class="row center">
        <a id="btnContact" class="cta-secondary hidden" href="#">Contact Us</a>
        <a id="btnCheckout" class="cta hidden" href="#">Proceed to Checkout</a>
      </div>
    </div>
  </div>
</main>

<script>
(function(){
  const q = new URLSearchParams(location.search);
  const slug = q.get('slug');

  if(!slug){
    document.body.innerHTML = '<main class="container"><p class="muted">Missing service.</p></main>';
    return;
  }

  const $ = (id)=>document.getElementById(id);

  fetch('data/services.json', {cache:'no-cache'})
    .then(r=>r.json())
    .then(list=>{
      // list can be array or {services:[...]} — support both
      const arr = Array.isArray(list) ? list : (Array.isArray(list.services) ? list.services : []);
      const svc = arr.find(x=>String(x.slug) === String(slug));
      if(!svc){ document.body.innerHTML = '<main class="container"><p class="muted">Service not found.</p></main>'; return; }

      // Name + crumbs
      $('svcName').textContent = svc.name || 'Service';
      $('crumbName').textContent = svc.name || 'Service';

      // ---------- Price (supports "Free") ----------
      const priceBox = $('price');
      const rawPrice = (svc.price ?? '').toString().trim();
      const rawSale  = (svc.sales_price ?? svc.salePrice ?? '').toString().trim();
      const isFree     = rawPrice.toLowerCase() === 'free';
      const isSaleFree = rawSale.toLowerCase() === 'free';
      const fmt = n => Number(n).toLocaleString(undefined,{style:'currency',currency:'USD'});

      if (isSaleFree) {
        const pNum = Number(rawPrice);
        if (Number.isFinite(pNum) && pNum > 0) priceBox.innerHTML = `Free <s>${fmt(pNum)}</s>`;
        else priceBox.textContent = 'Free';
      } else if (isFree) {
        priceBox.textContent = 'Free';
      } else {
        const pNum  = Number(rawPrice);
        const spNum = Number(rawSale);
        if (Number.isFinite(spNum) && Number.isFinite(pNum) && spNum > 0 && spNum < pNum) {
          priceBox.innerHTML = `${fmt(spNum)} <s>${fmt(pNum)}</s>`;
        } else if (Number.isFinite(pNum) && pNum > 0) {
          priceBox.textContent = fmt(pNum);
        } else {
          priceBox.textContent = '';
        }
      }
      // ---------------------------------------------

      // Description
      $('desc').textContent = svc.description || '';

      // Bullets
      const ul = $('bullets');
      (svc.bullets || []).forEach(b=>{
        const li = document.createElement('li');
        li.textContent = b;
        ul.appendChild(li);
      });

      // ----- MEDIA (image OR video OR YouTube/Vimeo) -----
      const box = $('mediaBox');
      const mediaUrl = (svc.image || '').trim();
      const mediaEl = buildMedia(mediaUrl, svc.name || 'Service', msg => {
        const alt = document.createElement('div');
        alt.style.cssText='display:flex;align-items:center;justify-content:center;min-height:220px;background:#f5f6fb;color:#555;font-weight:600;border-radius:12px;text-align:center;padding:12px;';
        alt.textContent = msg || 'Media could not be loaded';
        box.appendChild(alt);
      });
      if (mediaEl) box.appendChild(mediaEl);

      // ===== ACTION BUTTONS =====
      // actionType: 'contact' | 'checkout' | 'both'
      const type = String(svc.actionType || '').toLowerCase().trim();

      const btnContact  = $('btnContact');
      const btnCheckout = $('btnCheckout');

      const origin = location.origin || (location.protocol + '//' + location.host);
      const contactPage = new URL('/ContactUs.html', origin).href;

      // ✅ Determine display price for URL (supports "Free")
      const rp = (svc.price ?? '').toString().trim();
      const rs = (svc.sales_price ?? svc.salePrice ?? '').toString().trim();
      let displayPrice = '';
      if (rs.toLowerCase() === 'free' || rp.toLowerCase() === 'free') {
        displayPrice = 'Free';
      } else {
        const p  = Number(rp);
        const sp = Number(rs);
        if (Number.isFinite(sp) && Number.isFinite(p) && sp > 0 && sp < p) displayPrice = sp;
        else if (Number.isFinite(p) && p > 0) displayPrice = p;
      }

      // default checkout (can be overridden by checkoutLink)
      const defaultCheckoutHref = new URL(`/checkout.html?slug=${encodeURIComponent(svc.slug)}`, origin).href;
      const checkoutHref = (svc.checkoutLink && svc.checkoutLink.trim())
        ? new URL(svc.checkoutLink, origin).href
        : defaultCheckoutHref;

      // ALWAYS show Contact Us button → ContactUs.html?service=...&price=...&slug=...
      const contactUrl = (function(){
        const u = new URL(contactPage);
        if (svc.name) u.searchParams.set('service', svc.name);
        if (displayPrice !== '') u.searchParams.set('price', String(displayPrice));
        if (svc.slug) u.searchParams.set('slug', svc.slug);
        return u.href;
      })();

      btnContact.classList.remove('hidden');
      btnContact.href = contactUrl;

      // Show checkout/continue button per actionType (Contact Us stays visible for all)
      if (type === 'checkout') {
        btnCheckout.classList.remove('hidden');
        const u = new URL(contactUrl);
        u.searchParams.set('next', checkoutHref);
        btnCheckout.href = u.href;
        btnCheckout.textContent = 'Checkout';
      } else if (type === 'both') {
        btnCheckout.classList.remove('hidden');
        const u = new URL(contactUrl);
        u.searchParams.set('next', checkoutHref);
        btnCheckout.href = u.href;
        btnCheckout.textContent = 'Continue to Checkout';
      }
      // if type === 'contact' -> only Contact Us shows (already visible)
    })
    .catch(()=>{
      document.body.innerHTML = '<main class="container"><p class="muted">Could not load service.</p></main>';
    });

  // ------- helpers -------
  function buildMedia(url, altText, onFail){
    if (!url) return null;

    // YouTube
    const yt = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([A-Za-z0-9_\-]+)/i);
    if (yt) {
      const iframe = document.createElement('iframe');
      iframe.src = `https://www.youtube.com/embed/${yt[1]}`;
      iframe.title = 'YouTube video player';
      iframe.loading = 'lazy';
      iframe.referrerPolicy = 'strict-origin-when-cross-origin';
      iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
      iframe.setAttribute('allowfullscreen','');
      iframe.addEventListener('error', () => { console.error('YouTube load error:', url); onFail('Video unavailable'); });
      return iframe;
    }

    // Vimeo
    const vm = url.match(/vimeo\.com\/(\d+)/i);
    if (vm) {
      const iframe = document.createElement('iframe');
      iframe.src = `https://player.vimeo.com/video/${vm[1]}`;
      iframe.title = 'Vimeo video player';
      iframe.loading = 'lazy';
      iframe.allow = 'autoplay; fullscreen; picture-in-picture';
      iframe.setAttribute('allowfullscreen','');
      iframe.addEventListener('error', () => { console.error('Vimeo load error:', url); onFail('Video unavailable'); });
      return iframe;
    }

    // Direct file by extension
    const clean = url.split('?')[0].split('#')[0];
    const ext = (clean.match(/\.(\w+)$/) || [,''])[1].toLowerCase();
    const videoTypes = { mp4:'video/mp4', webm:'video/webm', ogv:'video/ogg', mov:'video/quicktime' };
    const imageTypes = { jpg:1, jpeg:1, png:1, gif:1, webp:1, avif:1, svg:1 };

    if (ext === 'mov') {
      const mp4Guess = clean.replace(/\.mov$/i, '.mp4') + (url.includes('?') ? '?' + url.split('?')[1] : '');
      return makeVideo(mp4Guess, { fallbackUrl: url, onFail });
    }

    if (videoTypes[ext]) return makeVideo(url, { onFail });
    if (imageTypes[ext] || !ext) return makeImage(url, altText);

    const img = makeImage(url, altText);
    img.addEventListener('error', () => {
      console.warn('Unknown media type and image failed:', url);
      onFail('Open media');
    });
    return img;
  }

  function makeImage(url, altText){
    const img = document.createElement('img');
    img.src = url;
    img.alt = altText || 'service image';
    img.loading = 'lazy';
    img.addEventListener('error', () => console.error('Image failed:', url));
    return img;
  }

  function makeVideo(url, { fallbackUrl=null, onFail=()=>{} } = {}){
    const v = document.createElement('video');
    v.muted = true; v.loop = true; v.autoplay = true; v.playsInline = true; v.preload = 'metadata';

    const src = document.createElement('source');
    src.src = url;
    const guessed = url.split('?')[0].split('#')[0].split('.').pop().toLowerCase();
    if (guessed === 'mp4') src.type = 'video/mp4';
    else if (guessed === 'webm') src.type = 'video/webm';
    else if (guessed === 'ogv') src.type = 'video/ogg';
    v.appendChild(src);
    v.appendChild(document.createTextNode('Sorry, your browser doesn’t support embedded videos.'));

    v.addEventListener('loadedmetadata', () => { try { v.playbackRate = 0.7; } catch(e){} });
    v.addEventListener('error', () => {
      console.error('Video error:', url, v.error);
      if (fallbackUrl && fallbackUrl !== url) {
        console.warn('Trying MOV fallback:', fallbackUrl);
        src.src = fallbackUrl; v.load();
      } else {
        v.controls = true;
        onFail('Video could not be loaded');
      }
    });
    setTimeout(() => { if (v.paused) v.controls = true; }, 1200);
    return v;
  }
})();
</script>
</body>
</html>
